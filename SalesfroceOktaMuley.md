<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SalesfroceOktaMuley</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__left">
    <div class="stackedit__toc">
      
<ul>
<li><a href="#one-identity-across-salesforce.com-force.com-applications-and-mulesoft">One Identity across Salesforce.com, Force.com Applications and Mulesoft</a>
<ul>
<li><a href="#what-is-force.com">What is Force.com</a></li>
<li><a href="#what-is-api-gateway">What is API Gateway?</a></li>
<li><a href="#setup-your-okta-developer-instance">Setup your Okta developer instance</a></li>
<li><a href="#setup-your-salesforce.com-developer-instance">Setup your Salesforce.com developer instance</a></li>
<li><a href="#setup-a-custom-domain-for-your-salesforce-instance">Setup a custom domain for your Salesforce instance</a></li>
<li><a href="#integrate-okta-as-a-oidc-provider-within-salesforce">Integrate Okta as a OIDC Provider within Salesforce</a></li>
<li><a href="#modify-the-salesforce-application-login-redirect-uri-oidc-configuration">Modify the Salesforce Application Login Redirect URI OIDC configuration</a></li>
<li><a href="#enable-login-with-okta-using-oidc-within-salesforce">Enable Login with Okta using OIDC within Salesforce</a></li>
<li><a href="#setup-your-salesforce-mulesoft-instance">Setup your Salesforce Mulesoft instance</a></li>
<li><a href="#deploy-a-sample-api-in-salesforce-mulesoft">Deploy a sample API in Salesforce Mulesoft</a></li>
<li><a href="#setup-salesforce-mulesoft-as-oauth-as-a-service-application-in-okta">Setup Salesforce Mulesoft as OAuth as a Service Application in Okta</a></li>
<li><a href="#integrate-okta-as-a-oidc-client-provider-in-salesforce-mulesoft">Integrate Okta as a OIDC Client Provider in Salesforce Mulesoft</a></li>
<li><a href="#setup-a-proxy-and-apply-a-security-policy-in-salesforce-mulesoft">Setup a proxy and apply a security policy in Salesforce Mulesoft</a></li>
<li><a href="#get-the-auth-provider-id-from-salesforce">Get the Auth Provider ID from Salesforce</a></li>
<li><a href="#modify-the-logic-of-the-auto-generated-registration-handler-in-salesforce">Modify the logic of the Auto Generated Registration Handler in Salesforce</a></li>
<li><a href="#configure-trust-over-the-remote-url-called-above-in-salesforce.">Configure trust over the remote URL called above in Salesforce.</a></li>
<li><a href="#create-a-visualforce-page-to-tie-everything-up">Create a Visualforce page to tie everything up</a></li>
<li><a href="#testing-it-all-out">Testing it all out</a></li>
</ul>
</li>
</ul>

    </div>
  </div>
  <div class="stackedit__right">
    <div class="stackedit__html">
      <h1 id="one-identity-across-salesforce.com-force.com-applications-and-mulesoft">One Identity across <a href="http://Salesforce.com">Salesforce.com</a>, <a href="http://Force.com">Force.com</a> Applications and Mulesoft</h1>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/SalesforceOktaMuley.gif" alt=""></p>
<p>In this tutorial, we’ll integrate the custom applications your organisation has developed using Salesforce’s <a href="http://Force.com">Force.com</a> platform capability with Okta Identity Cloud through Open ID Connect (aka ‘OIDC’). This tutorial will take this one notch further by extending Okta Identity Cloud also integrate with Mulesoft API Gateway.</p>
<p>Through this approach, you should be able to have any user who is accessing your custom application deployed in Salesforce to be authenticated by Okta. Once your user is authenticated, Okta will generate an access token via JWT format to the custom application you have developed in <a href="http://Salesforce.com">Salesforce.com</a>. As a result, your custom application will be able to know who’s the user who has authenticated and later on leverage the access token generated by Okta to securely call an API protected by Mulesoft API Gateway.</p>
<h2 id="what-is-force.com">What is <a href="http://Force.com">Force.com</a></h2>
<p><a href="http://Force.com">Force.com</a> is Salesforce’s Platform-as-a-Service capability (aka ‘PaaS’) which allows any organisation to develop and build custom applications on top of the Salesforce application which is delivered as Software-as-a-Service (aka ‘SaaS’). - <a href="https://developer.salesforce.com/platform/force.com">https://developer.salesforce.com/platform/force.com</a></p>
<p>In this tutorial, you’ll be using <a href="https://developer.salesforce.com/docs/atlas.en-us.pages.meta/pages/pages_intro_what_is_it.htm">Visualforce</a> framework to build your front end or presentation layer and <a href="https://developer.salesforce.com/docs/atlas.en-us.apexcode.meta/apexcode/apex_intro_what_is_apex.htm">APEX</a> development framework to build your back end as the business logic layer.</p>
<p><img src="https://www.researchgate.net/publication/330884357/figure/fig2/AS:745543332540417@1554762790411/Principles-of-working-of-visualforce-CRM-Salesforce-trailhead-Salesforce-developers.png" alt="Principles of working of visualforce (CRM Salesforce; trailhead ..."></p>
<h2 id="what-is-api-gateway">What is API Gateway?</h2>
<p>“An API gateway is a firewall that sits between your API and your users. They range from the simplest proxies which apply throttling and white/blacklisting to fully configurable platforms with fine-grained access mapping individual permissions to specific HTTP verbs and endpoints. Realistically, using an API gateway is not necessary but it makes some things faster, easier, and more reliable, which allows you to focus on your API.” - <a href="https://developer.okta.com/books/api-security/gateways/">Keith Casey</a>, API Problem Solver.</p>
<p>In this tutorial, you’ll be using <a href="https://www.mulesoft.com/">Salesforce’s MuleSoft</a> as the API Gateway that will protect an API and you’ll leverage the access token you have obtained earlier to securely and programmatically call this API through the custom application you have developed within Salesforce.</p>
<p><img src="https://app.lucidchart.com/publicSegments/view/fea032a3-7323-4ec6-8ffd-fbb7fe43058b/image.png" alt=""></p>
<h2 id="setup-your-okta-developer-instance">Setup your Okta developer instance</h2>
<p>To do this, the expectation is that you have already signed up for an Okta tenant. Head on over to <a href="http://developer.okta.com">developer.okta.com</a> and create an Okta org if you haven’t already.</p>
<p>For this example, I’ll be using my own Okta tenant which is [<a href="https://phdemo.oktapreview.com">https://phdemo.oktapreview.com</a>)</p>
<p>Login as your Okta Super Administrator. Click Applications and Add Application. Click Web and click Next.</p>
<p><img src="https://lh6.googleusercontent.com/JZy2ZwpBg5K3ciEMU1gFCm5d3dJ5ciRB30BWvDc9t3Ed0WwNjWytDDfdmOxGOsNsP11emqJaQ2Ge_ogW_G3HfHEEVv6r-nd679-8TDw3g0PNgT_V1_jkJkRAQPzcvK2Z67JgnCLL" alt=""></p>
<p>This creates an OpenID Connect application which will represent <a href="http://Salesforce.com">Salesforce.com</a> as an application. Change the Name to Salesforce Custom Application and also within the Grant Type allowed section, make sure you have Authorization Code and Implicit (Hybrid) ticked. As for the others, leave it as it is as you’ll change that later on.</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen+Shot+2020-08-15+at+11.26.32+PM.png" alt=""></p>
<p>Click Done.</p>
<p>Note the Client ID and Secret as you will use this on the Salesforce OIDC configuration part.</p>
<p><img src="https://lh6.googleusercontent.com/IzkHTrfG_6SmI300ruVPA5rBOyQ19_VLGTXMf-CpZfNiSLm0A1N0-Rf74GuT6e18IBlF-sBDoZzoJiOpOPUpyQ8bKhMlmG_nh1DecpgWCgRdwCiYOG5Hr2EIFW9Gv0BzLFpAJEBR" alt=""></p>
<h2 id="setup-your-salesforce.com-developer-instance">Setup your <a href="http://Salesforce.com">Salesforce.com</a> developer instance</h2>
<p>You can sign up for a free <a href="http://Saleforce.com">Saleforce.com</a> developer edition instance through this <a href="https://developer.salesforce.com/signup">link</a>.</p>
<p>Once you have signed up and successfully created your instance. You should be able to navigate to your <a href="http://Salesforce.com">Salesforce.com</a> admin console. Normally, it should be in the format like of <a href="https://ap5.salesforce.com/lightning/setup/SetupOneHome/home">https://ap5.salesforce.com/lightning/setup/SetupOneHome/home</a></p>
<h2 id="setup-a-custom-domain-for-your-salesforce-instance">Setup a custom domain for your Salesforce instance</h2>
<p>You should navigate to Setup &gt; Settings &gt; Company Settings &gt; My Domain</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%201.42.35%20PM.png" alt=""></p>
<p>Enter the custom domain you wish to use and click check Availability. If the domain you’ve nominated is still available, you should get a green check saying domain is available and then click ‘Register Domain’. You should be able to get this message below:</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%201.43.16%20PM.png" alt=""></p>
<p>Once the custom domain configuration has been applied, when you navigate back to the said screen, you should see some updates on the said page:</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%201.49.25%20PM.png" alt=""></p>
<p>Make sure you click the Log in button such that you can test your access to the custom domain. Once you are able to verify the custom domain. Click Deploy to Users such that we can leverage the custom domain for all your users in Salesforce later on.</p>
<p>We will get back to this page in the latter process such that we can allow users be able to log in to Salesforce using OIDC which will be covered after this section.</p>
<h2 id="integrate-okta-as-a-oidc-provider-within-salesforce">Integrate Okta as a OIDC Provider within Salesforce</h2>
<p>To on-board Okta as a OIDC provider within Salesforce, within the Salesforce Setup Admin Console, you should navigate to Setup &gt; Settings &gt; Identity &gt; Auth. Providers.</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-15%20at%2011.36.05%20PM.png" alt=""></p>
<p>Click New. Select Open ID Connect as the Provider Type.</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-15%20at%2011.36.57%20PM.png" alt=""></p>
<p>Fill in the fields with the red marker.</p>
<p>Name can be any name you wish to name this config.</p>
<p>URL suffix will be your okta subdomain. Using my environment will result to phdemo.</p>
<p>Consumer Key will be the Client ID of the application you’ve created earlier.</p>
<p>Consumer Secret will be the Client Secret of the application you’ve created earlier.</p>
<p>For the following endpoints, we will be using the default authorisation server that is enabled within every Okta instance.</p>
<p>Authorize Endpoint URL should be: https://.okta.com/oauth2/default/v1/authorize. (e.g.: <a href="https://phdemo.oktapreview.com/oauth2/default/v1/authorize">https://phdemo.oktapreview.com/oauth2/default/v1/authorize</a>)</p>
<p>Token Endpoint URL should be: https://.okta.com/oauth2/default/v1/token. (e.g.: <a href="https://phdemo.oktapreview.com/oauth2/default/v1/token">https://phdemo.oktapreview.com/oauth2/default/v1/token</a>)</p>
<p>User Info Endpoint URL should be: https://.okta.com/oauth2/default/v1/userinfo. (e.g.: <a href="https://phdemo.oktapreview.com/oauth2/default/v1/userinfo">https://phdemo.oktapreview.com/oauth2/default/v1/userinfo</a>)</p>
<p>Token Issuer Endpoint URL should be: https://.okta.com/oauth2/default. (e.g.: <a href="https://phdemo.oktapreview.com/oauth2/default">https://phdemo.oktapreview.com/oauth2/default</a>)</p>
<p>Default scopes should be profile openid email</p>
<p>You should have something like this:</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-15%20at%2011.38.33%20PM.png" alt=""></p>
<p>The next section is more Salesforce related.</p>
<p>You need to set a registration handler as part of the process. Luckily, Salesforce allows us to click a link that will automatically create the register handler. Click the said link.</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-15%20at%2011.37.51%20PM.png" alt=""></p>
<p>Once clicked, you should have something like this:</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-15%20at%2011.37.57%20PM.png" alt=""></p>
<p>You also need to make sure you set the field ‘Execute Registration As’ with your account You should end up something like this:</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-15%20at%2011.38.39%20PM.png" alt=""></p>
<p>Once you are done with above, click Save and you should end up with this in total:</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%201.33.01%20PM.png" alt=""></p>
<p>You should have noticed that after saving the OIDC configuration, Salesforce have generated URLs below the OIDC config. You need to copy the values for the following fields</p>
<p>Test-Only Initialization URL - e.g.: <a href="https://oktaoidc-dev-ed.my.salesforce.com/services/auth/test/phdemo">https://oktaoidc-dev-ed.my.salesforce.com/services/auth/test/phdemo</a></p>
<p>OAuth-Only Initialization URL - e.g.: <a href="https://oktaoidc-dev-ed.my.salesforce.com/services/auth/oauth/phdemo">https://oktaoidc-dev-ed.my.salesforce.com/services/auth/oauth/phdemo</a></p>
<p>Callback URL - e.g.: <a href="https://login.salesforce.com/services/authcallback/00D2v000002F7VWEA0/phdemo">https://login.salesforce.com/services/authcallback/00D2v000002F7VWEA0/phdemo</a></p>
<h2 id="modify-the-salesforce-application-login-redirect-uri-oidc-configuration">Modify the Salesforce Application Login Redirect URI OIDC configuration</h2>
<p>Go back to the application instance you have created in Okta and update the Login redirect URIs with the values provided above.</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%201.36.39%20PM.png" alt=""></p>
<p>Once done, click save to make sure your changes are reflected back in the OIDC application within Okta.</p>
<h2 id="enable-login-with-okta-using-oidc-within-salesforce">Enable Login with Okta using OIDC within Salesforce</h2>
<p>As mentioned in the previous step (Setup a custom domain for your Salesforce instance), navigate back to Setup &gt; Settings &gt; Company Settings &gt; My Domain.</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%201.49.25%20PM.png" alt=""></p>
<p>Click the ‘Edit’ button under Authentication Configuration. You should be able to see the OIDC configuration as a checkbox option under Authentication Service. You need to tick this such that users can log into Salesforce using Okta through OIDC.</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%202.05.01%20PM.png" alt=""></p>
<p>Click Save once done. You should have something like this.</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%202.05.10%20PM.png" alt=""></p>
<p>You should be able to see additional buttons as a way to login once you naviate to your custom salesforce domain URL. I’m using <a href="http://oktaoidc-dev-ed.my.salesforce.com"><strong>oktaoidc-dev-ed.my.salesforce.com</strong></a></p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%202.13.04%20PM.png" alt=""></p>
<h2 id="setup-your-salesforce-mulesoft-instance">Setup your Salesforce Mulesoft instance</h2>
<p>You should be able to sign up for a free 30 day trial of Mulesoft through this <a href="https://anypoint.mulesoft.com/login/#/signup?apintent=generic">link</a>.</p>
<p>Once you have signed up, you should be able to login to <a href="https://anypoint.mulesoft.com/login/?apintent=generic">Mulesoft Anypoint Platform</a>.</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%202.30.51%20PM.png" alt=""></p>
<h2 id="deploy-a-sample-api-in-salesforce-mulesoft">Deploy a sample API in Salesforce Mulesoft</h2>
<p>Once you are logged inside Salesforce Mulesoft, navigate to Design Center from the side bar navigation.</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%206.22.37%20PM.png" alt=""></p>
<p>Click + Create new</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%206.23.47%20PM.png" alt=""></p>
<p>Click + Create API specification</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%206.24.03%20PM.png" alt=""></p>
<p>Provide any name you wish to use. Select Visual Editor radio button . Click Create specification</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%206.25.38%20PM.png" alt=""></p>
<p>You should be taken to a new page within the Design Center. Click Import Example. Tick Contact API Tutorial and click the import asset button.</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%206.26.20%20PM.png" alt=""></p>
<p>Click Import &amp; Replace.<img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%206.27.31%20PM.png" alt=""></p>
<p>You should see on the left hand side that there is one resource already available and this resource is called “/contacts”.</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%206.27.46%20PM.png" alt=""></p>
<p>Click Publish-&gt;Publish to Exchange. Provide a version number and click Publish to Exchange.</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%206.29.01%20PM.png" alt=""></p>
<h2 id="setup-salesforce-mulesoft-as-oauth-as-a-service-application-in-okta">Setup Salesforce Mulesoft as OAuth as a Service Application in Okta</h2>
<p>Return back to your Okta instance as your Okta Super Administrator. Click Applications and Add Application. Click Service and click Next.</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%206.48.01%20PM.png" alt=""></p>
<p>Provide a name. Click done.</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%206.45.21%20PM.png" alt=""></p>
<p>Take note of the Client ID and Client secret here as you will use this later on the step below.</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%206.45.58%20PM.png" alt=""></p>
<h2 id="integrate-okta-as-a-oidc-client-provider-in-salesforce-mulesoft">Integrate Okta as a OIDC Client Provider in Salesforce Mulesoft</h2>
<p>Return back to the home page of the Anypoint Platform.</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%206.22.37%20PM.png" alt=""></p>
<p>Navigate to Management Center &gt; Access Management.</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%206.39.43%20PM.png" alt=""></p>
<p>Navigate to Access Management &gt; Client Providers.</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%206.52.22%20PM.png" alt=""></p>
<p>Click Add Client Provider &gt; Open ID Connect Dynamic Client Registration</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%206.40.58%20PM.png" alt=""></p>
<p>Provide the following:</p>
<p>Name: Any name you wish</p>
<p>Description: Any description you wish</p>
<p><strong>Under Dynamic Client Registration:</strong></p>
<p>Issuer should be: https://.okta.com/oauth2/default. (e.g.: <a href="https://phdemo.oktapreview.com/oauth2/default">https://phdemo.oktapreview.com/oauth2/default</a>)</p>
<p>Client Registration URL should be: https://.okta.com/oauth2/v1/clients. (e.g.: <a href="https://phdemo.oktapreview.com/oauth2/v1/clients">https://phdemo.oktapreview.com/oauth2/v1/clients</a>)</p>
<p><strong>Leave the Authorization Header as blank</strong></p>
<p><strong>Under Token Introspection Client:</strong></p>
<p>Client ID should be the client id generated from the last step.</p>
<p>Client Secret should be the client secret generated from the last step.</p>
<p><strong>Under OpenID Connect Authorization URLs:</strong></p>
<p>Authorize URL should be: https://.okta.com/oauth2/default/v1/authorize. (e.g.: <a href="https://phdemo.oktapreview.com/oauth2/default/v1/authorize">https://phdemo.oktapreview.com/oauth2/default/v1/authorize</a>)</p>
<p>Token URL should be: https://.okta.com/oauth2/default/v1/token. (e.g.: <a href="https://phdemo.oktapreview.com/oauth2/default/v1/token">https://phdemo.oktapreview.com/oauth2/default/v1/token</a>)</p>
<p>Token Introspection URL should be: https://.okta.com/oauth2/default/v1/introspect. (e.g.: <a href="https://phdemo.oktapreview.com/oauth2/default/v1/introspect">https://phdemo.oktapreview.com/oauth2/default/v1/introspect</a>)</p>
<p>You should end up something like this:</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%206.59.33%20PM.png" alt=""></p>
<p>Click Save.</p>
<p>Navigate to Access Management &gt; Environments</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%207.03.02%20PM.png" alt=""></p>
<p>Click Sandbox and make sure you add the client provider you’ve just created earlier within the environment.</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%207.03.41%20PM.png" alt=""></p>
<p>click Update.</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%207.04.16%20PM.png" alt=""></p>
<p>You should end up with this.</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%207.06.38%20PM.png" alt=""></p>
<h2 id="setup-a-proxy-and-apply-a-security-policy-in-salesforce-mulesoft">Setup a proxy and apply a security policy in Salesforce Mulesoft</h2>
<p>You should return back to Anypoint Platform home page and navigate to Management Center &gt; API Manager</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%207.10.20%20PM.png" alt=""></p>
<p>Click Manage API &gt; Manage API from Exchange</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%207.10.25%20PM.png" alt=""></p>
<p>Search for the Mulesoft API which we have created earlier.</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%207.10.46%20PM.png" alt=""></p>
<p>Within Managing type, tick the Endpoint with Proxy radio button.</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%207.11.47%20PM.png" alt=""></p>
<p>Select CloudHub as the default option and you should end up with this and Click Save.</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%207.13.08%20PM.png" alt=""></p>
<p>You’ll be redirected to a new page.</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%207.13.47%20PM.png" alt=""></p>
<p>Under the deployment configuration, set Runtime version to 3.9.x and provide any name you wish to use for your proxy.</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%207.14.38%20PM.png" alt=""></p>
<p>Take note of the proxy application url as you will use that later after this step.</p>
<p>Once the deployment is successful, you should see this screen.</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%207.20.56%20PM.png" alt=""></p>
<p>On the left hand side, click Policies.</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%207.21.32%20PM.png" alt=""></p>
<p>Click Apply New Policy. Search for Open ID Connect access token enforcement and tick it.</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%207.22.07%20PM.png" alt=""></p>
<p>Click Configure Policy.</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%207.22.27%20PM.png" alt=""></p>
<p>Enter openid profile email within the scopes and tick skip client id validation. Click Apply.</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%207.22.37%20PM.png" alt=""></p>
<p>You should now see a new record within the API level policies.</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%207.23.17%20PM.png" alt=""></p>
<p>You have completed the configuration setup with Salesforce Mulesoft. The next step will let you integrate Salesforce Mulesoft protected API with Salesforce.</p>
<h2 id="get-the-auth-provider-id-from-salesforce">Get the Auth Provider ID from Salesforce</h2>
<p>As per <a href="https://developer.salesforce.com/docs/atlas.en-us.apexcode.meta/apexcode/apex_class_Auth_AuthToken.htm">salesforce documentation</a>, you need to provide a 18-character identinfier to get the access token from your 3rd party identity provider,</p>
<p>If you notice in the earlier steps where we created an auth provider in Salesforce, the id only has 15-characters and is missing 3 more characters.</p>
<p>To get the 18 characters full value, you can go through this steps below.</p>
<p>Navigate to Setup &gt; Platform Tools &gt; Custom Code &gt; Apex Classes</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%207.31.40%20PM.png" alt=""></p>
<p>Click Developer Console.</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-17%20at%2011.17.05%20AM.png" alt=""></p>
<p>Under File &gt; Click Open Resource</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-17%20at%2011.17.09%20AM.png" alt=""></p>
<p>Search for AuthProvider.obj then click Open</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-17%20at%2011.17.21%20AM.png" alt=""></p>
<p>Select Id and click query twice.</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-17%20at%2011.17.42%20AM.png" alt=""></p>
<p>You should now see a new text area below. Clic Execute</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-17%20at%2011.17.51%20AM.png" alt=""></p>
<p>You should now see a query results</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-17%20at%2011.17.57%20AM.png" alt=""></p>
<p>Take note of the Auth. Provider ID value as you will use this later on within the code snippet of the Autocreated Registration Handler.</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%201.33.01%20PM.png" alt=""></p>
<p>You can also either try to append ‘GA0’ in the end of your existing Auth Provider ID generated previously. It might work as well or we can call it as a hack.</p>
<h2 id="modify-the-logic-of-the-auto-generated-registration-handler-in-salesforce">Modify the logic of the Auto Generated Registration Handler in Salesforce</h2>
<p>You should return back to Salesforce.</p>
<p>Remember the Autogenerated Registration Handler which was created earlier, you’ll be now modifying it such that it can do the following:</p>
<ol>
<li>
<p>Show the access token obtained from Okta</p>
</li>
<li>
<p>Call the Okta userinfo API endpoint to show all the user details using the access token</p>
</li>
<li>
<p>Add the access token in the Authorization Header of a HTTP request such that Mulesoft API Gateway is able to verify if the user is allowed to call the API protected by Mulesoft.</p>
</li>
</ol>
<p>Navigate to Setup &gt; Platform Tools &gt; Custom Code &gt; Apex Classes</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%207.31.40%20PM.png" alt=""></p>
<p>You should be able to see the auto created registration handler earlier.</p>
<p>Click the Edit link. You should be taken to an editor. Overwrite the existing code with the following code inside your class.</p>
<pre class=" language-java"><code class="prism  language-java">
<span class="token keyword">public</span> String accessToken<span class="token punctuation">;</span>

<span class="token keyword">public</span> String callOut<span class="token punctuation">{</span>get<span class="token punctuation">;</span>set<span class="token punctuation">;</span><span class="token punctuation">}</span>

<span class="token keyword">public</span> String sub<span class="token punctuation">{</span>get<span class="token punctuation">;</span>set<span class="token punctuation">;</span><span class="token punctuation">}</span>

<span class="token keyword">public</span> String name<span class="token punctuation">{</span>get<span class="token punctuation">;</span>set<span class="token punctuation">;</span><span class="token punctuation">}</span>

<span class="token keyword">public</span> String email<span class="token punctuation">{</span>get<span class="token punctuation">;</span>set<span class="token punctuation">;</span><span class="token punctuation">}</span>

<span class="token keyword">public</span> String firstName<span class="token punctuation">{</span>get<span class="token punctuation">;</span>set<span class="token punctuation">;</span><span class="token punctuation">}</span>

<span class="token keyword">public</span> String lastName<span class="token punctuation">{</span>get<span class="token punctuation">;</span>set<span class="token punctuation">;</span><span class="token punctuation">}</span>

<span class="token keyword">public</span> String userName<span class="token punctuation">{</span>get<span class="token punctuation">;</span>set<span class="token punctuation">;</span><span class="token punctuation">}</span>

  

<span class="token keyword">public</span> String <span class="token function">getAccessToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token punctuation">{</span>

HttpRequest req <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Http http <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Http</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

String url <span class="token operator">=</span> <span class="token string">' https://phdemo.oktapreview.com/oauth2/default/v1/userinfo'</span><span class="token punctuation">;</span> <span class="token comment">//change this to your Okta developer instance userinfo url</span>

req<span class="token punctuation">.</span><span class="token function">setEndpoint</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>

req<span class="token punctuation">.</span><span class="token function">setMethod</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

req<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Accept'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

req<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Authorization'</span><span class="token punctuation">,</span> <span class="token string">'Bearer '</span><span class="token operator">+</span> Auth<span class="token punctuation">.</span>AuthToken<span class="token punctuation">.</span><span class="token function">getAccessToken</span><span class="token punctuation">(</span><span class="token string">'0SO2v000000XjXAGA0'</span><span class="token punctuation">,</span> <span class="token string">'Open ID Connect'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//change the first parameter to the Auth. Provider ID obtained earlier.</span>

HTTPResponse resp <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span>

<span class="token punctuation">{</span>

Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">&gt;</span> values <span class="token operator">=</span> <span class="token punctuation">(</span>Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">&gt;</span><span class="token punctuation">)</span>JSON<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  

sub <span class="token operator">=</span> values<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'sub'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

name <span class="token operator">=</span> values<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

email <span class="token operator">=</span> values<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'email'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

userName <span class="token operator">=</span> values<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'preferred_username'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

firstName <span class="token operator">=</span> values<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'given_name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

lastname <span class="token operator">=</span> values<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'family_name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">return</span> Auth<span class="token punctuation">.</span>AuthToken<span class="token punctuation">.</span><span class="token function">getAccessToken</span><span class="token punctuation">(</span><span class="token string">'0SO2v000000XjXAGA0'</span><span class="token punctuation">,</span> <span class="token string">'Open ID Connect'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//change the first parameter to the Auth. Provider ID obtained earlier.</span>

<span class="token punctuation">}</span>

  

<span class="token keyword">public</span> PageReference <span class="token function">fetch_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  

HttpRequest req <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Http http <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Http</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

String url <span class="token operator">=</span> <span class="token string">' http://protectedmulesoftapi.us-e2.cloudhub.io/contacts'</span><span class="token punctuation">;</span> <span class="token comment">//change this to your Mulesoft API proxy endpoint you've created earlier</span>

req<span class="token punctuation">.</span><span class="token function">setEndpoint</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>

req<span class="token punctuation">.</span><span class="token function">setMethod</span><span class="token punctuation">(</span><span class="token string">'GET'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

req<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Accept'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

req<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Authorization'</span><span class="token punctuation">,</span> <span class="token string">'Bearer '</span><span class="token operator">+</span> Auth<span class="token punctuation">.</span>AuthToken<span class="token punctuation">.</span><span class="token function">getAccessToken</span><span class="token punctuation">(</span><span class="token string">'0SO2v000000XjXAGA0'</span><span class="token punctuation">,</span> <span class="token string">'Open ID Connect'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//change the first parameter to the Auth. Provider ID obtained earlier.</span>

HTTPResponse resp <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>

system<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">'INSIDE CALLOUT:'</span><span class="token operator">+</span>resp<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null<span class="token punctuation">)</span>

<span class="token punctuation">{</span>

Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">&gt;</span> values <span class="token operator">=</span> <span class="token punctuation">(</span>Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">&gt;</span><span class="token punctuation">)</span>JSON<span class="token punctuation">.</span><span class="token function">deserialize</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> String<span class="token operator">&gt;</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

String append <span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">;</span>

append <span class="token operator">=</span> values<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'FirstName'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">':'</span> <span class="token operator">+</span> values<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'LastName'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">':'</span> <span class="token operator">+</span> values<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'Email'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">':'</span> <span class="token operator">+</span> values<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'Company'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

callOut <span class="token operator">=</span> append<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">return</span> null<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

global <span class="token keyword">boolean</span> <span class="token function">canCreateUser</span><span class="token punctuation">(</span>Auth<span class="token punctuation">.</span>UserData data<span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token comment">//TODO: Check whether we want to allow creation of a user with this data</span>

<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

global User <span class="token function">createUser</span><span class="token punctuation">(</span>Id portalId<span class="token punctuation">,</span> Auth<span class="token punctuation">.</span>UserData data<span class="token punctuation">)</span><span class="token punctuation">{</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">canCreateUser</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

<span class="token comment">//Returning null or throwing an exception fails the SSO flow</span>

<span class="token keyword">return</span> null<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token comment">//The user is authorized, so create their Salesforce user</span>

User u <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Profile p <span class="token operator">=</span> <span class="token punctuation">[</span>SELECT Id FROM profile WHERE name<span class="token operator">=</span><span class="token string">'Standard Platform User'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">//TODO: Customize the username. Also check that the username doesn't already exist and</span>

<span class="token comment">//possibly ensure there are enough org licenses to create a user. Must be 80 characters</span>

<span class="token comment">//or less.</span>

u<span class="token punctuation">.</span>username <span class="token operator">=</span> data<span class="token punctuation">.</span>username<span class="token punctuation">;</span>

u<span class="token punctuation">.</span>email <span class="token operator">=</span> data<span class="token punctuation">.</span>email<span class="token punctuation">;</span>

u<span class="token punctuation">.</span>lastName <span class="token operator">=</span> data<span class="token punctuation">.</span>lastName<span class="token punctuation">;</span>

u<span class="token punctuation">.</span>firstName <span class="token operator">=</span> data<span class="token punctuation">.</span>firstName<span class="token punctuation">;</span>

String alias <span class="token operator">=</span> data<span class="token punctuation">.</span>username<span class="token punctuation">;</span>

<span class="token comment">//Alias must be 8 characters or less</span>

<span class="token keyword">if</span><span class="token punctuation">(</span>alias<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

alias <span class="token operator">=</span> alias<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

u<span class="token punctuation">.</span>alias <span class="token operator">=</span> alias<span class="token punctuation">;</span>

u<span class="token punctuation">.</span>languagelocalekey <span class="token operator">=</span> <span class="token string">'en_US'</span><span class="token punctuation">;</span>

u<span class="token punctuation">.</span>localesidkey <span class="token operator">=</span> <span class="token string">'en_US'</span><span class="token punctuation">;</span>

u<span class="token punctuation">.</span>emailEncodingKey <span class="token operator">=</span> <span class="token string">'UTF-8'</span><span class="token punctuation">;</span>

u<span class="token punctuation">.</span>timeZoneSidKey <span class="token operator">=</span> <span class="token string">'America/Los_Angeles'</span><span class="token punctuation">;</span>

u<span class="token punctuation">.</span>profileId <span class="token operator">=</span> p<span class="token punctuation">.</span>Id<span class="token punctuation">;</span>

insert u<span class="token punctuation">;</span>

<span class="token keyword">return</span> u<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

global <span class="token keyword">void</span> <span class="token function">updateUser</span><span class="token punctuation">(</span>Id userId<span class="token punctuation">,</span> Id portalId<span class="token punctuation">,</span> Auth<span class="token punctuation">.</span>UserData data<span class="token punctuation">)</span><span class="token punctuation">{</span>

User u <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>id<span class="token operator">=</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>

u<span class="token punctuation">.</span>email <span class="token operator">=</span> data<span class="token punctuation">.</span>email<span class="token punctuation">;</span>

u<span class="token punctuation">.</span>lastName <span class="token operator">=</span> data<span class="token punctuation">.</span>lastName<span class="token punctuation">;</span>

u<span class="token punctuation">.</span>firstName <span class="token operator">=</span> data<span class="token punctuation">.</span>firstName<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre>
<p>Click Save.</p>
<p>Navigate Back to the Apex Class home page.</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%207.31.40%20PM.png" alt=""></p>
<p>Click Security</p>
<p>Make sure you add Standard Platform User as an enabled Profile. Click Save.</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-17%20at%2011.09.00%20AM.png" alt=""></p>
<h2 id="configure-trust-over-the-remote-url-called-above-in-salesforce.">Configure trust over the remote URL called above in Salesforce.</h2>
<p>Navigate to Setup &gt; Settings &gt; Security &gt;Remote Site Settings</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%207.34.25%20PM.png" alt=""></p>
<p>Click New Remote Site.</p>
<p>Add your Okta URL. (e.g.: <a href="https://domain.okta.com">https://domain.okta.com</a>)</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%207.34.43%20PM.png" alt=""></p>
<p>Add your Salesforce Mulesoft Proxy Endpoint URL. (e.g.: <a href="https://domain.cloudhub.io">https://domain.cloudhub.io</a>)</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%207.37.58%20PM.png" alt=""></p>
<p>You are now done trusting the remote URLs the APEX code which are being used by the earlier.</p>
<h2 id="create-a-visualforce-page-to-tie-everything-up">Create a Visualforce page to tie everything up</h2>
<p>Within Salesforce, navigate to Platform Tools &gt; Custom Code &gt; Visualforce Pages</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%207.41.56%20PM.png" alt=""></p>
<p>Click New. Provide a Label, Name and Description.</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/Screen%20Shot%202020-08-16%20at%207.42.34%20PM.png" alt=""></p>
<p>Overwrite and paste the following code below:</p>
<pre class=" language-html"><code class="prism  language-html">
<span class="token comment">&lt;!-- change the control value with the class name of your controller --&gt;</span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">apex:</span>page</span> <span class="token attr-name">controller</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>AutocreatedRegHandler1380796002690<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- Begin Default Content REMOVE THIS --&gt;</span>

  

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>Congratulations<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>

This is your Salesforce page protected by Okta OIDC and OAuth 2.0

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">apex:</span>form</span> <span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">apex:</span>commandButton</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>btn<span class="token punctuation">"</span></span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{!fetch_data}<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>Call Protected API behind Mulesoft using OAuth JWT Token below<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">/&gt;</span></span>

Token: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">apex:</span>outputLabel</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>one<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>{!accessToken}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">apex:</span>outputLabel</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">/&gt;</span></span>

Access Token Details from https://yourdomain.oktapreview.com/oauth2/default/v1/userinfo: <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">apex:</span>outputText</span> <span class="token punctuation">&gt;</span></span>Sub : {!sub}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">apex:</span>outputText</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">apex:</span>outputText</span> <span class="token punctuation">&gt;</span></span>Full Name : {!name}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">apex:</span>outputText</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">apex:</span>outputText</span> <span class="token punctuation">&gt;</span></span>Email : {!email}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">apex:</span>outputText</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">apex:</span>outputText</span> <span class="token punctuation">&gt;</span></span>Username : {!userName}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">apex:</span>outputText</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">apex:</span>outputText</span> <span class="token punctuation">&gt;</span></span>First Name: {!firstName}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">apex:</span>outputText</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">apex:</span>outputText</span> <span class="token punctuation">&gt;</span></span>Last Name : {!lastName}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">apex:</span>outputText</span><span class="token punctuation">&gt;</span></span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token punctuation">/&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">apex:</span>outputText</span> <span class="token punctuation">&gt;</span></span>Callout : {!callOut}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">apex:</span>outputText</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">apex:</span>form</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- End Default Content REMOVE THIS --&gt;</span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span><span class="token namespace">apex:</span>page</span><span class="token punctuation">&gt;</span></span>

</code></pre>
<p>Click Save.</p>
<p>You should be done with the Salesforce Configuration and setup.</p>
<h2 id="testing-it-all-out">Testing it all out</h2>
<p>To access or test the Visualforce page you’ve created, you should be able to access it using the url in the format of: https://salesforce-custom-domain-name-ed–c.visualforce.com/apex/pageName. (e.g.: <a href="https://oktaoidc-dev-ed--c.visualforce.com/apex/OktaPage">https://oktaoidc-dev-ed–c.visualforce.com/apex/OktaPage</a>)</p>
<p><img src="https://dj1byplsgj7mi.cloudfront.net/SalesforceOktaMulesoftBlog/SalesforceOktaMuley.gif" alt=""></p>
<p>In summary, this developer blog post should have enabled you to integrate Okta as the identity provider to your Salesforce, custom applications deployed in Salesforce using <a href="http://Force.com">Force.com</a> (APEX &amp; Visualforce) and also Salesforce Mulesoft API Gateway plus the APIs managed by Mulesoft.</p>
<p>Credits and Shout out to my colleague <a href="https://www.linkedin.com/in/ewan-thomas-872b3294/">Ewan Thomas</a> for helping me out troubleshoot the Salesforce APEX handler.</p>
<p>If you have more questions, feel free to contact me: <a href="mailto:jefferson.haw@okta.com">jefferson.haw@okta.com</a>.</p>

    </div>
  </div>
</body>

</html>
